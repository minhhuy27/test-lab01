name: CD

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    defaults:
      run:
        shell: bash
    runs-on: ubuntu-latest
    env:
      DBT_PROFILES_DIR: dbt
      DBT_PACKAGES_INSTALL_PATH: /tmp/dbt_packages_cache
      DBT_TARGET_PATH: /tmp/dbt_target
      DBT_LOG_PATH: /tmp/dbt_logs
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DBT_SQLSERVER_HOST: localhost
      DBT_SQLSERVER_USER: SA
      DBT_SQLSERVER_PASSWORD: YourStrong@Passw0rd
      DBT_SQLSERVER_DATABASE: AdventureWorks2014
      DBT_SQLSERVER_SCHEMA: dbo
      DBT_SQLSERVER_DRIVER: "ODBC Driver 18 for SQL Server"
    outputs:
      target_name: ${{ steps.env_target.outputs.target_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: "Determine environment target"
        id: env_target
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "target_name=prod" >> "$GITHUB_OUTPUT"
            echo "schema=dbt_prod" >> "$GITHUB_OUTPUT"
          else
            echo "target_name=dev" >> "$GITHUB_OUTPUT"
            echo "schema=dbt_dev" >> "$GITHUB_OUTPUT"
          fi
          echo "DBT_SQLSERVER_SCHEMA=${schema}" >> "$GITHUB_ENV"
          echo "Deploy target: ${GITHUB_REF##*/} -> $(cat $GITHUB_OUTPUT)"

      - name: "Install system dependencies (ODBC for SQL Server)"
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends curl ca-certificates gnupg lsb-release unixodbc unixodbc-dev
          KEYRING=/usr/share/keyrings/microsoft-prod.gpg
          sudo mkdir -p "$(dirname "$KEYRING")" /etc/apt/sources.list.d
          sudo rm -f /etc/apt/sources.list.d/mssql-release.list
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor --batch --yes -o "$KEYRING"
          # Pin to Debian 11 repo for driver 18
          echo "deb [arch=amd64 signed-by=${KEYRING}] https://packages.microsoft.com/debian/11/prod bullseye main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y DEBIAN_FRONTEND=noninteractive apt-get install -y msodbcsql18

      - name: "Install Python dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.8.7 dbt-sqlserver==1.8.7

      - name: "Pre-check: DB connectivity and DB existence"
        run: |
          docker compose -f docker-compose.yml up -d sqlserver
          for i in {1..30}; do
            if docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "select 1" >/dev/null 2>&1; then
              echo "SQL Server is up"; break
            fi
            echo "Waiting for SQL Server... ($i)"
            sleep 5
          done
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "SELECT name FROM sys.databases WHERE name='AdventureWorks2014'"
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "IF DB_ID('AdventureWorks2014') IS NULL RESTORE DATABASE AdventureWorks2014 FROM DISK = '/tmp/AdventureWorks2014.bak' WITH MOVE 'AdventureWorks2014_Data' TO '/var/opt/mssql/data/AdventureWorks2014.mdf', MOVE 'AdventureWorks2014_Log' TO '/var/opt/mssql/data/AdventureWorks2014_log.ldf'"
          for i in {1..24}; do
            if docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "SELECT state_desc FROM sys.databases WHERE name='AdventureWorks2014'" | grep -q ONLINE; then
              echo "AdventureWorks2014 is online"; break
            fi
            echo "Waiting for AdventureWorks2014 to come online... ($i)"
            sleep 5
          done
          # ensure target schema exists
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = '${DBT_SQLSERVER_SCHEMA}') EXEC('CREATE SCHEMA [${DBT_SQLSERVER_SCHEMA}]')"

      - name: dbt deps
        run: |
          mkdir -p "$DBT_PACKAGES_INSTALL_PATH" "$DBT_TARGET_PATH" "$DBT_LOG_PATH"
          dbt deps --project-dir dbt --profiles-dir dbt

      - name: dbt run
        run: dbt run --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH" --target ${{ steps.env_target.outputs.target_name }}

      - name: dbt test
        run: dbt test --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH" --target ${{ steps.env_target.outputs.target_name }}

      - name: "Post-check: basic health query"
        run: |
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "SELECT TOP 1 name, create_date FROM sys.tables ORDER BY create_date DESC"
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "SELECT COUNT(*) AS gold_sales_rows FROM AdventureWorks2014.[${DBT_SQLSERVER_SCHEMA}].gld_sales_summary"

      - name: Upload dbt logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-logs
          path: ${{ env.DBT_LOG_PATH }}

      - name: "Upload manifest for rollback reference"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-manifest-${{ steps.env_target.outputs.target_name }}
          path: |
            ${{ env.DBT_TARGET_PATH }}/manifest.json
            ${{ env.DBT_TARGET_PATH }}/run_results.json

      - name: "Notify (GitHub summary)"
        if: always()
        run: |
          echo "## CD Result" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: $GITHUB_REF" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${{ steps.env_target.outputs.target_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Logs artifact: dbt-logs" >> $GITHUB_STEP_SUMMARY

      - name: "Notify commit (GitHub comment)"
        if: always() && github.event.repository.fork == false
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const target = '${{ steps.env_target.outputs.target_name }}';
            const body = `CD ${status} (target=${target}) on ${context.ref}\nLogs: dbt-logs`;
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body
            });

      - name: "Notify Slack"
        if: always() && env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        run: |
          STATUS="${{ job.status }}"
          TARGET="${{ steps.env_target.outputs.target_name }}"
          COLOR="danger"
          if [[ "$STATUS" == "success" ]]; then COLOR="good"; fi
          payload=$(cat <<EOF
          {
            "text": "*CD ${GITHUB_REF##*/}* - target: ${TARGET}, status: ${STATUS}",
            "attachments": [
              {
                "color": "${COLOR}",
                "fields": [
                  {"title": "Repo", "value": "${GITHUB_REPOSITORY}", "short": true},
                  {"title": "Branch", "value": "${GITHUB_REF##*/}", "short": true},
                  {"title": "Target", "value": "${TARGET}", "short": true},
                  {"title": "Status", "value": "${STATUS}", "short": true}
                ]
              }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

      - name: "Rollback (manual)"
        if: always() && env.ROLLBACK == 'true'
        run: |
          echo "Rollback requested (ROLLBACK=true). Restoring AdventureWorks2014 from backup..."
          docker compose -f docker-compose.yml up -d sqlserver
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "RESTORE DATABASE AdventureWorks2014 FROM DISK = '/tmp/AdventureWorks2014.bak' WITH REPLACE, MOVE 'AdventureWorks2014_Data' TO '/var/opt/mssql/data/AdventureWorks2014.mdf', MOVE 'AdventureWorks2014_Log' TO '/var/opt/mssql/data/AdventureWorks2014_log.ldf'"
        env:
          ROLLBACK: ${{ github.event.inputs.rollback || 'false' }}
