name: CI

on:
  pull_request:
    branches: ["*", "**"]
  push:
    branches: [main, master, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test:
    runs-on: ubuntu-latest
    env:
      DBT_PROFILES_DIR: dbt
      DBT_PACKAGES_INSTALL_PATH: /tmp/dbt_packages_cache
      DBT_TARGET_PATH: /tmp/dbt_target
      DBT_SQLSERVER_HOST: localhost
      DBT_SQLSERVER_USER: SA
      DBT_SQLSERVER_PASSWORD: YourStrong@Passw0rd
      DBT_SQLSERVER_DATABASE: AdventureWorks2014
      DBT_SQLSERVER_SCHEMA: dbo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install system dependencies (ODBC for SQL Server)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends curl ca-certificates gnupg lsb-release unixodbc unixodbc-dev
          # Use a single keyring path to avoid Signed-By conflicts on GitHub runners
          KEYRING=/usr/share/keyrings/microsoft-prod.gpg
          sudo mkdir -p "$(dirname "$KEYRING")"
          sudo rm -f /etc/apt/sources.list.d/mssql-release.list
          sudo rm -f /etc/apt/keyrings/microsoft.gpg
          if [ ! -f "$KEYRING" ]; then
            curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor --batch --yes --output "$KEYRING"
          fi
          DISTRO=$(lsb_release -rs)          # e.g., 22.04 on GitHub runners
          CODENAME=$(lsb_release -cs)        # e.g., jammy
          echo "deb [arch=amd64 signed-by=${KEYRING}] https://packages.microsoft.com/ubuntu/${DISTRO}/prod ${CODENAME} main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y DEBIAN_FRONTEND=noninteractive apt-get install -y msodbcsql18

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            dbt-core==1.8.7 \
            dbt-sqlserver==1.8.7 \
            black==23.12.1 \
            flake8==6.1.0 \
            sqlfluff==3.0.5

      - name: Validate PR title (conventional commits)
        if: github.event_name == 'pull_request'
        run: |
          title="${{ github.event.pull_request.title }}"
          if [[ ! "$title" =~ ^(feat|fix|chore|docs|test|ci|build|refactor|perf|revert):\  ]]; then
            echo "PR title phải theo dạng conventional commits, ví dụ: feat: add feature"
            exit 1
          fi

      - name: Check large files (>1MB) in diff
        run: |
          base_ref="${{ github.base_ref }}"
          if [ -n "$base_ref" ]; then
            git fetch origin "$base_ref" --depth=1 || true
            diff_files=$(git diff --name-only "origin/$base_ref"...)
          else
            diff_files=$(git diff --name-only HEAD~1)
          fi
          max_size=$((1024*1024))
          for f in $diff_files; do
            if [ -f "$f" ]; then
              size=$(stat -c%s "$f")
              if [ "$size" -gt "$max_size" ]; then
                echo "::error file=$f::File size $size bytes > 1MB"
                exit 1
              fi
            fi
          done

      - name: Check conflict markers
        run: |
          if rg --hidden --glob '!**/.git/**' '^(<{7}|={7}|>{7})'; then
            echo "Conflict markers detected."
            exit 1
          fi

      - name: Lint Python (black, flake8)
        run: |
          black --check .
          flake8 .

      - name: Lint SQL (sqlfluff)
        run: sqlfluff lint dbt/models --config .sqlfluff

      - name: Bring up SQL Server for dbt
        run: |
          docker compose -f docker-compose.yml up -d sqlserver
          # wait for SQL Server to accept connections
          for i in {1..30}; do
            if docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "select 1" >/dev/null 2>&1; then
              echo "SQL Server is up"; break
            fi
            echo "Waiting for SQL Server... ($i)"
            sleep 5
          done
          # restore DB if missing
          docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "IF DB_ID('AdventureWorks2014') IS NULL RESTORE DATABASE AdventureWorks2014 FROM DISK = '/tmp/AdventureWorks2014.bak' WITH MOVE 'AdventureWorks2014_Data' TO '/var/opt/mssql/data/AdventureWorks2014.mdf', MOVE 'AdventureWorks2014_Log' TO '/var/opt/mssql/data/AdventureWorks2014_log.ldf'"
          # ensure DB is online
          for i in {1..24}; do
            if docker compose exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P YourStrong@Passw0rd -Q "SELECT state_desc FROM sys.databases WHERE name='AdventureWorks2014'" | grep -q ONLINE; then
              echo "AdventureWorks2014 is online"; break
            fi
            echo "Waiting for AdventureWorks2014 to come online... ($i)"
            sleep 5
          done

      - name: dbt deps
        run: |
          mkdir -p "$DBT_PACKAGES_INSTALL_PATH" "$DBT_TARGET_PATH"
          dbt deps --project-dir dbt --profiles-dir dbt

      - name: dbt compile
        run: dbt compile --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH"

      - name: dbt run
        run: dbt run --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH"

      - name: dbt test
        run: dbt test --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH"

      - name: Generate dbt docs
        run: dbt docs generate --project-dir dbt --profiles-dir dbt --target-path "$DBT_TARGET_PATH"

      - name: Upload dbt docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: ${{ env.DBT_TARGET_PATH }}
